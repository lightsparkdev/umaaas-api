---
title: "Self-Custody Wallet Integration"
description: "Send and receive cryptocurrency to and from user-controlled wallets"
---

## Overview

Grid supports sending Bitcoin via Lightning Network to self-custody wallets using Spark wallet addresses. This enables users to maintain full control of their crypto while benefiting from Grid's fiat-to-crypto conversion and payment rails.

<Info>
  Spark wallets use the Lightning Network for instant, low-cost Bitcoin
  transactions. Users can receive payments directly to their self-custody
  wallets without Grid holding their funds.
</Info>

## How it works

1. **User provides wallet address** - Get Spark wallet address from user
2. **Create quote** - Generate quote for fiat-to-crypto or crypto-to-crypto transfer
3. **Execute transfer** - Send crypto directly to user's wallet
4. **Instant settlement** - Lightning Network provides near-instant confirmation

## Prerequisites

- Customer created in Grid
- Valid Spark wallet address from user
- Webhook endpoint for payment notifications (optional, for status updates)

## Sending crypto to self-custody wallets

### Step 1: Collect wallet address

Request the user's Spark wallet address. Spark addresses start with `sprt1` and are typically 90+ characters long.

Example valid address:
```
sprt1pgssyuuuhnrrdjswal5c3s3rafw9w3y5dd4cjy3duxlf7hjzkp0rqx6dj6mrhu
```

Validate the address format in your application before submitting to the API:
- Must start with `sprt1`
- Must be at least 90 characters
- Should not contain whitespace

<Warning>
  Always validate wallet addresses before creating quotes. Invalid addresses
  will cause transaction failures and potential fund loss.
</Warning>

### Step 2: Create external account for the wallet

Register the Spark wallet as an external account:

<CodeGroup>
```bash cURL
curl -X POST 'https://api.lightspark.com/grid/2025-10-13/customers/external-accounts' \
  -H 'Authorization: Basic <base64-encoded-credentials>' \
  -H 'Content-Type: application/json' \
  -d '{
    "customerId": "Customer:019542f5-b3e7-1d02-0000-000000000001",
    "currency": "BTC",
    "beneficiary": {
      "counterPartyType": "INDIVIDUAL",
      "fullName": "John Doe",
      "email": "john@example.com"
    },
    "accountInfo": {
      "accountType": "SPARK_WALLET",
      "address": "sprt1pgssyuuuhnrrdjswal5c3s3rafw9w3y5dd4cjy3duxlf7hjzkp0rqx6dj6mrhu"
    }
  }'
```

```javascript Node.js
const externalAccount = await fetch(
  "https://api.lightspark.com/grid/2025-10-13/customers/external-accounts",
  {
    method: "POST",
    headers: {
      Authorization: `Basic ${credentials}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      customerId: "Customer:019542f5-b3e7-1d02-0000-000000000001",
      currency: "BTC",
      beneficiary: {
        counterPartyType: "INDIVIDUAL",
        fullName: "John Doe",
        email: "john@example.com",
      },
      accountInfo: {
        accountType: "SPARK_WALLET",
        address: sparkAddress,
      },
    }),
  }
).then((r) => r.json());

console.log("External account ID:", externalAccount.id);
```

```python Python
import requests
import base64

credentials = base64.b64encode(
    f"{api_token_id}:{api_secret}".encode()
).decode()

response = requests.post(
    'https://api.lightspark.com/grid/2025-10-13/customers/external-accounts',
    headers={
        'Authorization': f'Basic {credentials}',
        'Content-Type': 'application/json'
    },
    json={
        'customerId': 'Customer:019542f5-b3e7-1d02-0000-000000000001',
        'currency': 'BTC',
        'beneficiary': {
            'counterPartyType': 'INDIVIDUAL',
            'fullName': 'John Doe',
            'email': 'john@example.com'
        },
        'accountInfo': {
            'accountType': 'SPARK_WALLET',
            'address': spark_address
        }
    }
)

external_account = response.json()
print(f"External account ID: {external_account['id']}")
```

</CodeGroup>

<Tip>
  Store the external account ID for future transfers. Users can reuse the same
  wallet address for multiple transactions.
</Tip>

### Step 3: Create and execute a quote

#### Option A: From fiat to self-custody wallet

Convert fiat directly to crypto in user's wallet:

```bash
curl -X POST 'https://api.lightspark.com/grid/2025-10-13/quotes' \
  -H 'Authorization: Basic <base64-encoded-credentials>' \
  -H 'Content-Type: application/json' \
  -d '{
    "source": {
      "customerId": "Customer:019542f5-b3e7-1d02-0000-000000000001",
      "currency": "USD"
    },
    "destination": {
      "accountId": "ExternalAccount:e85dcbd6-dced-4ec4-b756-3c3a9ea3d965",
      "currency": "BTC"
    },
    "lockedCurrencySide": "SENDING",
    "lockedCurrencyAmount": 10000,
    "description": "Buy Bitcoin to self-custody wallet"
  }'
```

The response includes payment instructions for funding and the amount of BTC the user will receive.

#### Option B: From internal account to self-custody wallet

Transfer crypto from internal account to user's wallet (same-currency transfer, no quote needed):

```bash
curl -X POST 'https://api.lightspark.com/grid/2025-10-13/transfer-out' \
  -H 'Authorization: Basic <base64-encoded-credentials>' \
  -H 'Content-Type: application/json' \
  -d '{
    "source": {
      "accountId": "InternalAccount:a12dcbd6-dced-4ec4-b756-3c3a9ea3d123"
    },
    "destination": {
      "accountId": "ExternalAccount:e85dcbd6-dced-4ec4-b756-3c3a9ea3d965"
    },
    "amount": 100000
  }'
```

The response includes the transaction ID for tracking.

### Step 4: Monitor transfer completion

Track the transfer status via webhooks. Configure your webhook endpoint to receive `OUTGOING_PAYMENT` events:

- **COMPLETED**: Bitcoin successfully sent to wallet
- **FAILED**: Transfer failed (check `failureReason` field)

Example webhook payload for a completed transfer:
```json
{
  "type": "OUTGOING_PAYMENT",
  "transaction": {
    "id": "Transaction:...",
    "status": "COMPLETED",
    "customerId": "Customer:...",
    "receivedAmount": {
      "amount": 100000,
      "currency": { "code": "BTC", "decimals": 8 }
    },
    "destination": {
      "accountInfo": {
        "address": "sprt1pg..."
      }
    }
  }
}
```

Use these events to notify users about successful transfers or handle failures.

## Best practices

<AccordionGroup>
<Accordion title="Validate wallet addresses">
Always validate Spark addresses before processing to prevent transaction failures:

**Validation checks:**
- Must start with `sprt1`
- Must be at least 90 characters long
- Should not contain whitespace or line breaks
- Only lowercase alphanumeric characters allowed

Invalid addresses will cause transaction failures and potential fund loss.

</Accordion>

<Accordion title="Handle Lightning Network specifics">
Lightning Network has unique characteristics to consider:

**Transfer limits:**
- **Minimum**: 1,000 satoshis (0.00001 BTC)
- **Maximum**: 10,000,000 satoshis (0.1 BTC)

**Performance:**
- **Settlement time**: Instant (typically < 10 seconds)
- **Fees**: Very low (typically < 1%)

Validate amounts in your application to ensure they fall within Lightning Network limits before creating quotes.

</Accordion>

<Accordion title="Provide clear user instructions">
Help users understand the Lightning wallet process:

**Steps to receive Bitcoin:**
1. Open your Lightning wallet app
2. Navigate to the receive or deposit section
3. Copy your Spark wallet address (starts with `sprt1`)
4. Paste the address into your application
5. Confirm the transfer
6. Funds arrive instantly (typically < 10 seconds)

**Compatible wallets:**
- Spark Wallet
- Phoenix
- Breez
- Muun
- Blue Wallet (Lightning mode)

</Accordion>

<Accordion title="Handle failed transfers">
Implement appropriate error handling for transfer failures:

**Retryable failures** (temporary network issues):
- `TEMPORARY_NETWORK_ERROR`
- `INSUFFICIENT_LIQUIDITY`
- `ROUTE_NOT_FOUND`

Wait a few seconds and retry the transfer with the same quote ID.

**Non-retryable failures** (user action required):
- `INVALID_ADDRESS`: Wallet address is invalid - user must provide correct address
- `AMOUNT_TOO_SMALL`: Below 1,000 satoshi minimum - increase amount
- `AMOUNT_TOO_LARGE`: Exceeds Lightning Network limits - split into multiple transfers

Display clear error messages to help users resolve issues quickly.

</Accordion>
</AccordionGroup>

## Testing in sandbox

Test self-custody wallet flows in sandbox mode using test Spark addresses:

```bash
curl -X POST 'https://api.lightspark.com/grid/2025-10-13/quotes' \
  -H 'Authorization: Basic <base64-encoded-credentials>' \
  -H 'Content-Type: application/json' \
  -d '{
    "source": {
      "accountId": "InternalAccount:a12dcbd6-dced-4ec4-b756-3c3a9ea3d123"
    },
    "destination": {
      "externalAccountDetails": {
        "customerId": "Customer:019542f5-b3e7-1d02-0000-000000000001",
        "currency": "BTC",
        "accountInfo": {
          "accountType": "SPARK_WALLET",
          "address": "sprt1pgssyuuuhnrrdjswal5c3s3rafw9w3y5dd4cjy3duxlf7hjzkp0rqx6dj6mrhu"
        }
      }
    },
    "lockedCurrencySide": "SENDING",
    "lockedCurrencyAmount": 10000,
    "immediatelyExecute": true
  }'
```

<Tip>
  In sandbox mode, transfers to Spark wallets complete instantly without
  requiring actual Lightning Network transactions.
</Tip>

## Next steps

<CardGroup cols={2}>
<Card title="Fiat-crypto conversion" icon="arrow-right-arrow-left" href="/ramps/developer-guides/fiat-crypto-conversion">
  Learn about on-ramp and off-ramp flows
</Card>

<Card
  title="External accounts"
  icon="building-columns"
  href="/payouts/depositing-funds/external-accounts"
>
  Manage external accounts including Spark wallets
</Card>

<Card
  title="Webhooks"
  icon="webhook"
  href="/remittances/developer-guides/webhooks"
>
  Set up webhooks to monitor transaction status
</Card>

<Card title="Sandbox testing" icon="flask" href="/remittances/developer-guides/sandbox-testing">
  Test wallet integrations in sandbox mode
</Card>
</CardGroup>
